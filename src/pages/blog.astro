---
import Navbar from "../layouts/Navigation.astro";
import Footer from "../layouts/Footer.astro";
import Layout from "../layouts/Layout.astro";
import BlogRobotViewer from "../components/BlogRobotViewer.astro";

import { getCollection } from "astro:content";
import type { CollectionEntry } from "astro:content";

const allBlogArticles: CollectionEntry<"blog">[] = await getCollection("blog");
---

<Layout>
  <div class="min-h-screen flex flex-col bg-secondary">
    <div class="flex-grow">
      <Navbar>
        <div class="relative overflow-hidden">
          <!-- Tech grid overlay -->
          <div class="absolute inset-0 tech-grid opacity-10 z-0 pointer-events-none"></div>

          <div class="relative z-10 sm:px-20 px-6 py-12">
            <!-- BOLD HEADER - Hidden Initially -->
            <div class="header-section mb-12 opacity-0" id="blog-header">
              <h1 class="blog-title font-mono font-black tracking-tighter leading-none select-none">
                <span class="char char-1">T</span><span class="char char-2">E</span><span class="char char-3">C</span><span class="char char-4">H</span><span class="char char-5">N</span><span class="char char-6">I</span><span class="char char-7">C</span><span class="char char-8">A</span><span class="char char-9">L</span>
                <br>
                <span class="char char-10">C</span><span class="char char-11">H</span><span class="char char-12">R</span><span class="char char-13">O</span><span class="char char-14">N</span><span class="char char-15">I</span><span class="char char-16">C</span><span class="char char-17">L</span><span class="char char-18">E</span><span class="char char-19">S</span>
              </h1>
              <div class="accent-line mt-6"></div>
            </div>

            <!-- Robot Viewer Container - Transitions from fullscreen to contained -->
            <div class="robot-viewer-wrapper" id="robot-viewer-wrapper">
              <!-- Content overlay (shown during intro) -->
              <div class="robot-text-overlay" id="robot-cta-text">
                <!-- Top text - large and bold -->
                <div class="top-statement mb-12 text-center">
                  <h2 class="statement-large font-mono font-bold tracking-tight leading-tight text-primary">
                    Here are some of my<br>unfiltered opinions
                  </h2>
                </div>

                <!-- Spacer for visual balance -->
                <div class="flex-grow max-h-32"></div>

                <!-- Bottom text - small and dismissive -->
                <div class="bottom-statement mt-12 text-center">
                  <p class="statement-small font-mono text-primary/40 italic tracking-wide">
                    not that anyone cares
                  </p>
                </div>
              </div>

              <!-- Robot Viewer (single instance) -->
              <BlogRobotViewer className="robot-viewer" />

              <!-- Expand button (shown after transition) -->
              <button
                class="expand-keyboard-button absolute top-4 right-4 w-10 h-10 bg-primary/10 rounded-full flex items-center justify-center text-primary/90 z-20 hover:bg-primary/30 transition-colors opacity-0 pointer-events-none"
                aria-label="Expand keyboard view"
                id="expand-keyboard-btn"
              >
                <svg
                  xmlns="http://www.w3.org/2000/svg"
                  viewBox="0 0 24 24"
                  fill="none"
                  stroke="currentColor"
                  class="w-5 h-5"
                >
                  <path
                    stroke-linecap="round"
                    stroke-linejoin="round"
                    stroke-width="2"
                    d="M15 3h6m0 0v6m0-6l-6 6M9 21H3m0 0v-6m0 6l6-6"></path>
                </svg>
              </button>
            </div>

      <!-- Blog Content - Hidden Initially -->
      <div id="blog-content" class="opacity-0 pointer-events-none transition-opacity duration-1000">
      <!-- Search Bar -->
      <div class="mb-8 relative">
        <div class="relative">
          <input 
            type="text" 
            id="searchInput" 
            placeholder="Search articles..." 
            class="w-full p-3 pl-10 rounded-lg border border-accent/30 bg-secondary focus:outline-none focus:ring-2 focus:ring-primary/50 focus:border-transparent"
          />
          <svg 
            xmlns="http://www.w3.org/2000/svg" 
            class="h-5 w-5 absolute left-3 top-1/2 transform -translate-y-1/2 text-primary/60" 
            fill="none" 
            viewBox="0 0 24 24" 
            stroke="currentColor"
          >
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z" />
          </svg>
        </div>
        <div id="searchStatus" class="text-sm mt-2 text-primary/60 hidden"></div>
      </div>

      <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-8" id="blogGrid">
        {allBlogArticles.map((article) => {
          const tags: string[] = article.data.tags || [];
          
          // Set a default status if undefined
          const defaultStatus = "Coming Soon";
          const actualStatus = article.data.status || defaultStatus;
          
          // Determine if the article is complete or not
          const isComplete = actualStatus === "Complete";
          const statusDisplay = isComplete ? "Complete" : defaultStatus;
          
          return (
            <a href={`/blog/${article.slug}`} class="group h-full relative blog-card">
              <div class="p-6 border border-accent/20 rounded-xl bg-secondary hover:bg-accent/5 transition-all duration-300 transform hover:-translate-y-1 hover:shadow-xl h-full flex flex-col relative z-10">
                <div class="flex flex-col h-full">
                  <div class="flex justify-between items-start mb-3">
                    <h2 class="text-xl font-bold group-hover:text-primary/90 transition-colors">{article.data.title}</h2>
                    <span class={`px-2 py-0.5 ml-2 rounded-full text-xs whitespace-nowrap flex-shrink-0 ${isComplete ? 'bg-green-100 text-green-800 dark:bg-green-900 dark:text-green-200' : 'bg-amber-100 text-amber-800 dark:bg-amber-900 dark:text-amber-200'}`}>
                      {statusDisplay}
                    </span>
                  </div>
                  <p class="text-sm text-primary/60 mb-4">{new Date(article.data.date).toLocaleDateString('en-US', { year: 'numeric', month: 'long', day: 'numeric' })}</p>
                  <p class="text-primary/80 flex-grow line-clamp-3">{article.data.description}</p>
                  <div class="mt-4 flex flex-wrap gap-2">
                    {tags.map(tag => (
                      <span class="px-3 py-1 text-xs rounded-full bg-accent/10 text-primary/70">{tag}</span>
                    ))}
                  </div>
                </div>
              </div>
              <div class="absolute inset-0 border border-primary/20 rounded-xl transform transition-all duration-300 group-hover:scale-105 group-hover:border-primary/40"></div>
            </a>
          );
        })}
      </div>
      </div> <!-- End blog-content -->
          </div>
        </div>
      </Navbar>
    </div>
    <Footer />
  </div>
</Layout>

<!-- Backdrop overlay for expanded view -->
<div
  id="keyboard-backdrop-overlay"
  class="fixed inset-0 bg-black/50 backdrop-blur-md z-40 opacity-0 pointer-events-none transition-opacity duration-300"
>
</div>

<style>
  /* Tech grid background */
  .tech-grid {
    background-image:
      linear-gradient(rgba(255, 255, 255, 0.03) 1px, transparent 1px),
      linear-gradient(90deg, rgba(255, 255, 255, 0.03) 1px, transparent 1px);
    background-size: 100px 100px;
    animation: gridPan 60s linear infinite;
  }

  @keyframes gridPan {
    0% { background-position: 0 0; }
    100% { background-position: 100px 100px; }
  }

  /* BOLD BLOG TITLE */
  .blog-title {
    font-size: clamp(2.5rem, 10vw, 10rem);
    line-height: 0.85;
    letter-spacing: -0.08em;
    color: #ffffff;
    text-transform: uppercase;
    text-shadow:
      0 3px 25px rgba(0, 0, 0, 0.9),
      0 6px 45px rgba(0, 0, 0, 0.7);
  }

  /* Animate title when shown */
  #blog-header {
    transition: opacity 1.2s cubic-bezier(0.16, 1, 0.3, 1);
  }

  @keyframes titleReveal {
    from {
      opacity: 0;
      transform: translateY(50px);
    }
    to {
      opacity: 1;
      transform: translateY(0);
    }
  }

  /* Character animations - don't animate initially */
  .blog-title .char {
    display: inline-block;
  }

  @keyframes charReveal {
    0% {
      opacity: 0;
      transform: translateY(100px) scale(0.8);
    }
    60% {
      transform: translateY(-10px) scale(1.02);
    }
    100% {
      opacity: 1;
      transform: translateY(0) scale(1);
    }
  }

  /* Accent line */
  .accent-line {
    height: 3px;
    width: 0;
    background: linear-gradient(90deg, rgba(255, 255, 255, 0.8), transparent);
    animation: lineExpand 1.5s cubic-bezier(0.16, 1, 0.3, 1) forwards;
    animation-delay: 1s;
  }

  @keyframes lineExpand {
    to {
      width: 200px;
    }
  }

  /* Robot Viewer Wrapper - Transitions from fullscreen to contained */
  .robot-viewer-wrapper {
    position: fixed;
    top: 0;
    left: 0;
    width: 100vw;
    height: 100vh;
    z-index: 20;
    transition: all 1.5s cubic-bezier(0.4, 0, 0.2, 1);
    display: flex;
    align-items: center;
    justify-content: center;
  }

  /* Contained state (after animation) */
  .robot-viewer-wrapper.contained {
    position: relative;
    width: 100%;
    height: 24rem; /* h-96 */
    margin-bottom: 3rem;
    z-index: 10;
  }

  @media (min-width: 768px) {
    .robot-viewer-wrapper.contained {
      height: 20rem; /* md:h-80 */
    }
  }

  @media (min-width: 640px) {
    .robot-viewer-wrapper.contained {
      height: 18rem; /* sm:h-72 */
    }
  }

  /* Text overlay during intro */
  .robot-text-overlay {
    position: absolute;
    inset: 0;
    z-index: 30;
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
    padding: 1rem;
    opacity: 1;
    transition: opacity 1s ease-out;
    pointer-events: none;
  }

  .robot-text-overlay.hidden {
    opacity: 0;
  }

  .robot-viewer-wrapper.contained .robot-text-overlay {
    display: none;
  }

  /* Expanded state */
  .robot-viewer-wrapper.expanded {
    position: fixed !important;
    top: 50% !important;
    left: 50% !important;
    transform: translate(-50%, -50%) !important;
    width: 90vw !important;
    height: 90vh !important;
    max-width: 1200px !important;
    max-height: 800px !important;
    z-index: 50 !important;
    border-radius: 12px;
    box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.5);
    border: 2px solid rgba(var(--color-primary, 255, 255, 255), 0.4);
  }

  /* Show expand button after transition to contained state */
  .robot-viewer-wrapper.contained .expand-keyboard-button {
    opacity: 1;
    pointer-events: auto;
  }

  /* Backdrop visible class */
  .backdrop-visible {
    opacity: 1 !important;
    pointer-events: auto !important;
  }

  .statement-large {
    font-size: clamp(2.5rem, 6vw, 5rem);
    line-height: 1.1;
    opacity: 1;
    text-shadow:
      0 3px 25px rgba(0, 0, 0, 0.9),
      0 6px 45px rgba(0, 0, 0, 0.7);
  }

  .statement-small {
    font-size: clamp(0.75rem, 1.5vw, 1rem);
    opacity: 1;
    text-shadow: 0 2px 10px rgba(0, 0, 0, 0.8);
  }

  @keyframes fadeIn {
    to { opacity: 1; }
  }

  @keyframes fadeInUp {
    from {
      opacity: 0;
      transform: translateY(30px);
    }
    to {
      opacity: 1;
      transform: translateY(0);
    }
  }

  /* Add Tailwind's line-clamp utility if not available in your Tailwind setup */
  .line-clamp-3 {
    display: -webkit-box;
    -webkit-line-clamp: 3;
    -webkit-box-orient: vertical;
    overflow: hidden;
  }
  
  /* Border animation styles */
  .blog-card {
    transition: transform 0.3s ease-out;
  }
  
  .blog-card:hover {
    transform: translateY(-4px);
  }

  /* Responsive */
  @media (max-width: 1024px) {
    .blog-title {
      font-size: clamp(2rem, 9vw, 8rem);
    }
  }

  @media (max-width: 768px) {
    .blog-title {
      font-size: clamp(1.8rem, 10vw, 7rem);
    }
  }

  @media (max-width: 640px) {
    .blog-title {
      font-size: clamp(1.5rem, 12vw, 5rem);
    }

    .statement-large {
      font-size: clamp(1.8rem, 7vw, 3rem);
    }

    .statement-small {
      font-size: clamp(0.65rem, 2vw, 0.85rem);
    }
  }

  @media (max-width: 768px) {
    .statement-large {
      font-size: clamp(2rem, 6vw, 3.5rem);
    }
  }
</style>

<script>
// Intro animation and transition
document.addEventListener('DOMContentLoaded', () => {
  // Listen for robot animation complete event
  document.addEventListener('blogRobotAnimationComplete', () => {
    console.log('Blog robot animation complete - starting transition');

    // Wait 1 second after animation completes to let user appreciate it
    setTimeout(() => {
      const robotViewerWrapper = document.getElementById('robot-viewer-wrapper');
      const robotCtaText = document.getElementById('robot-cta-text');
      const blogHeader = document.getElementById('blog-header');
      const blogContent = document.getElementById('blog-content');

      if (robotViewerWrapper && robotCtaText && blogHeader && blogContent) {
        // Fade out CTA text
        robotCtaText.classList.add('hidden');

        // After text fades, transition wrapper to contained state
        setTimeout(() => {
          // Transition robot wrapper from fullscreen to contained
          robotViewerWrapper.classList.add('contained');

          // Show blog header with animation
          blogHeader.style.opacity = '1';

          // Add interactive class to robot viewer to show decorative elements
          const robotViewer = document.querySelector('.robot-viewer');
          if (robotViewer) {
            setTimeout(() => {
              robotViewer.classList.add('interactive');
            }, 800);
          }

          // Show blog content
          setTimeout(() => {
            blogContent.classList.remove('opacity-0', 'pointer-events-none');
            blogContent.classList.add('opacity-100');
          }, 1000);
        }, 1000);
      }
    }, 1000);
  });

  // Handle expand/collapse functionality
  const expandButton = document.getElementById('expand-keyboard-btn');
  const backdropOverlay = document.getElementById('keyboard-backdrop-overlay');

  if (expandButton && robotViewerWrapper && backdropOverlay) {
    expandButton.addEventListener('click', (e) => {
      e.stopPropagation();
      e.preventDefault();
      toggleExpandedView();
    });

    backdropOverlay.addEventListener('click', () => {
      if (robotViewerWrapper.classList.contains('expanded')) {
        toggleExpandedView(false);
      }
    });

    document.addEventListener('keydown', (e) => {
      if (e.key === 'Escape' && robotViewerWrapper.classList.contains('expanded')) {
        toggleExpandedView(false);
      }
    });

    function toggleExpandedView(expand: boolean | null = null) {
      const shouldExpand = expand !== null ? expand : !robotViewerWrapper.classList.contains('expanded');

      if (shouldExpand) {
        robotViewerWrapper.classList.add('expanded');
        backdropOverlay.classList.add('backdrop-visible');
        document.body.style.overflow = 'hidden';
        expandButton.setAttribute('aria-label', 'Collapse keyboard view');

        const svg = expandButton.querySelector('svg');
        if (svg) {
          svg.style.transform = 'rotate(180deg)';
        }
      } else {
        robotViewerWrapper.classList.remove('expanded');
        backdropOverlay.classList.remove('backdrop-visible');
        document.body.style.overflow = '';
        expandButton.setAttribute('aria-label', 'Expand keyboard view');

        const svg = expandButton.querySelector('svg');
        if (svg) {
          svg.style.transform = '';
        }
      }
    }
  }
});

// Client-side search functionality
document.addEventListener('DOMContentLoaded', () => {
  const searchInput = document.getElementById('searchInput') as HTMLInputElement;
  const blogCards = document.querySelectorAll<HTMLElement>('.blog-card');
  const blogGrid = document.getElementById('blogGrid') as HTMLElement;
  const searchStatus = document.getElementById('searchStatus') as HTMLElement;
  
  if (!searchInput || !blogGrid || !searchStatus) {
    console.error('Required DOM elements not found');
    return;
  }
  
  searchInput.addEventListener('input', () => {
    const searchTerm = searchInput.value.toLowerCase().trim();
    let matchCount = 0;
    
    blogCards.forEach((card: HTMLElement) => {
      const titleElement = card.querySelector('h2');
      const descriptionElement = card.querySelector('p.text-primary\\/80');
      const tagElements = card.querySelectorAll('.mt-4 span');
      
      if (!titleElement || !descriptionElement) {
        console.warn('Blog card is missing required elements', card);
        return;
      }
      
      const title = titleElement.textContent?.toLowerCase() || '';
      const description = descriptionElement.textContent?.toLowerCase() || '';
      const tags = Array.from(tagElements).map(tag => tag.textContent?.toLowerCase() || '');
      
      // Check if the search term is found in title, description, or tags
      const matchesSearch = 
        title.includes(searchTerm) || 
        description.includes(searchTerm) || 
        tags.some(tag => tag.includes(searchTerm));
      
      // Toggle visibility based on search match
      if (matchesSearch || searchTerm === '') {
        card.classList.remove('hidden');
        matchCount++;
      } else {
        card.classList.add('hidden');
      }
    });
    
    // Show search status message
    if (searchTerm !== '') {
      searchStatus.classList.remove('hidden');
      searchStatus.textContent = `Found ${matchCount} article${matchCount !== 1 ? 's' : ''}`;
    } else {
      searchStatus.classList.add('hidden');
    }
    
    // Add empty state message if no results
    const emptyStateEl = document.getElementById('emptyState');
    if (matchCount === 0 && searchTerm !== '') {
      if (!emptyStateEl) {
        const emptyState = document.createElement('div');
        emptyState.id = 'emptyState';
        emptyState.className = 'col-span-1 sm:col-span-2 lg:col-span-3 text-center py-12';
        emptyState.innerHTML = `
          <svg xmlns="http://www.w3.org/2000/svg" class="h-12 w-12 mx-auto text-primary/30" fill="none" viewBox="0 0 24 24" stroke="currentColor">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9.172 16.172a4 4 0 015.656 0M9 10h.01M15 10h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z" />
          </svg>
          <p class="mt-4 text-lg text-primary/70">No articles found matching "${searchTerm}"</p>
          <button id="clearSearch" class="mt-2 text-primary hover:text-primary/80 underline">Clear search</button>
        `;
        blogGrid.appendChild(emptyState);
        
        // Add event listener to the clear button
        const clearButton = document.getElementById('clearSearch');
        if (clearButton) {
          clearButton.addEventListener('click', () => {
            searchInput.value = '';
            searchInput.dispatchEvent(new Event('input'));
          });
        }
      }
    } else if (emptyStateEl) {
      emptyStateEl.remove();
    }
  });
});
</script>