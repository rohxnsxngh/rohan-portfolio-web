---
import { getCollection } from "astro:content";
import type { CollectionEntry } from "astro:content";
import Layout from "../layouts/Layout.astro";
import Navbar from "../layouts/Navigation.astro";
import Footer from "../layouts/Footer.astro";
import ProjectImage from "../components/ProjectImage.astro";
import HeavyRobotModelViewer from "../components/HeavyRobotModelViewer.astro";

// Get all projects with error handling
let allProjects: CollectionEntry<"project">[] = [];
try {
  allProjects = await getCollection("project");
  console.log("Total projects found:", allProjects.length);
} catch (error) {
  console.error("Error fetching projects:", error);
}

// Make sure we have valid projects by removing any undefined entries
const validProjects = allProjects.filter(project => 
  project && project.data && project.data.title
);
console.log("Valid projects after filtering:", validProjects.length);

// Sort projects by status with fallback values
const sortedProjects = [...validProjects].sort((a, b) => {
  // Default status if missing
  const statusA = a.data?.status || "completed";
  const statusB = b.data?.status || "completed";
  
  // Sort by status (completed first, then in-progress, then coming-soon)
  const statusOrder = { completed: 0, "in-progress": 1, "coming-soon": 2 };
  const statusCompare = (statusOrder[statusA] || 0) - (statusOrder[statusB] || 0);
  
  // If same status, sort by date (newest first)
  if (statusCompare === 0) {
    const dateA = new Date(a.data?.date || 0).getTime();
    const dateB = new Date(b.data?.date || 0).getTime();
    return dateB - dateA;
  }
  
  return statusCompare;
});

console.log("Projects after sorting:", sortedProjects.length);
---

<Layout>
  <Navbar>
    <div class="sm:px-20 px-6 py-8">
      <h1 class="font-semibold sm:text-5xl text-3xl tracking-wider mb-8">
        Projects & Experiments
      </h1>

      <div class="divider"></div>
      
      <!-- Side-by-side Robot Model Viewer and Info (stacked on mobile) -->
      <div class="w-full mb-12 relative z-1">
        <div class="flex flex-col md:flex-row md:items-center gap-6">
          <!-- Robot Viewer - Full-width on mobile, partial width on desktop -->
          <div class="robot-showcase flex-1 relative w-full h-64 sm:h-72 md:h-80 lg:h-96 rounded-xl overflow-hidden border border-accent/20 transition-all duration-300 hover:shadow-lg">
            <HeavyRobotModelViewer />
            <button 
              class="expand-heavy-robot absolute top-4 right-4 w-10 h-10 bg-primary/10 rounded-full flex items-center justify-center text-primary/90 z-2 hover:bg-primary/30 transition-colors"
              aria-label="Expand robot view"
            >
              <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" class="w-5 h-5">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 3h6m0 0v6m0-6l-6 6M9 21H3m0 0v-6m0 6l6-6" />
              </svg>
            </button>
          </div>
          
          <!-- Info Card - Separate card on desktop, full width on mobile -->
          <div class="robot-info-card flex-1 md:flex-1 md:max-w-md p-6 rounded-xl bg-black/70 backdrop-blur-sm border border-accent/20">
            <h3 class="text-xl font-semibold text-white mb-3">Welcome to my Projects & Experiments Page</h3>
            <p class="text-white/80">This page mostly contains software and robotics projects, feel free to reach out if you find anything interesting!</p>
            <div class="mt-4 flex justify-start">
              <a href="#projects-section" class="inline-flex items-center text-primary/90 hover:text-primary transition-colors">
                <span class="mr-2">View Projects</span>
                <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="w-4 h-4 bounce-arrow-inline">
                  <path d="M12 5v14M5 12l7 7 7-7"/>
                </svg>
              </a>
            </div>
          </div>
        </div>
        
        <!-- Centered bounce arrow for mobile & desktop -->
        <div class="flex justify-center mt-6 md:mt-8">
          <div class="bounce-arrow w-10 h-10 flex items-center justify-center text-primary/80 cursor-pointer">
            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="w-8 h-8">
              <path d="M12 5v14M5 12l7 7 7-7"/>
            </svg>
          </div>
        </div>
      </div>

      <div id="projects-section" class="divider"></div>
      
      <!-- Project grid layout -->
      <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6 mt-8">
        {sortedProjects.length > 0 ? (
          sortedProjects.map((project) => {
            try {
              // Default values for missing data
              const title = project.data?.title || "Untitled Project";
              const description = project.data?.description || "No description available";
              const status = project.data?.status || "completed";
              const date = project.data?.date || new Date().toISOString();
              const tags = Array.isArray(project.data?.tags) ? project.data.tags : [];
              const github = project.data?.github || "";
              const demo = project.data?.demo || "";
              const kaggle = project.data?.kaggle || "";
              const image = project.data?.image || "";
              
              const statusColors = {
                completed: "bg-green-500/10 text-green-400",
                "in-progress": "bg-blue-500/10 text-blue-400",
                "coming-soon": "bg-purple-500/10 text-purple-400",
              };
              
              const statusText = {
                completed: "Completed",
                "in-progress": "In Progress",
                "coming-soon": "Coming Soon",
              };
              
              // Use default color if status is not recognized
              const statusColor = statusColors[status] || "bg-gray-500/10 text-gray-400";
              const statusDisplay = statusText[status] || "Unknown";
              
              return (
                <div class="relative z-1 project-card group">
                  <div class="h-full min-h-[200px] rounded-xl bg-black border border-accent/20 transition-all duration-300 hover:shadow-lg flex flex-col relative z-1 overflow-hidden">
                    {/* Add the ProjectImage component here */}
                    <ProjectImage 
                      image={image} 
                      title={title} 
                      tags={tags}
                    />
                    
                    <div class="p-6">
                      <div class="flex items-center justify-between mb-3">
                        <a href={`/project/${project.slug}`} class="text-xl font-bold text-white hover:text-primary/90 transition-colors">
                          {title}
                        </a>
                        <span
                          class={`px-2 py-1 text-xs rounded-full flex-shrink-0 ${statusColor}`}
                        >
                          {statusDisplay}
                        </span>
                      </div>
                      <p class="text-sm text-white/60 mb-4">
                        {new Date(date).toLocaleDateString("en-US", {
                          year: "numeric",
                          month: "long",
                        })}
                      </p>
                      <p class="text-white/80 flex-grow line-clamp-3">
                        {description}
                      </p>
                      <div class="mt-4 flex flex-wrap gap-2">
                        {tags.slice(0, 3).map((tag) => (
                          <span class="text-sm px-3 py-1 rounded-lg bg-accent/20 text-white/90 border border-accent/30 hover:bg-accent/30 transition-colors duration-200">
                            {tag}
                          </span>
                        ))}
                        {tags.length > 3 && (
                          <span class="text-sm px-3 py-1 rounded-lg bg-accent/10 text-white/70">
                            +{tags.length - 3} more
                          </span>
                        )}
                      </div>
                      {(github || demo || kaggle) && (
                        <div class="mt-4 pt-4 flex gap-4 border-t border-accent/10">
                          {github && (
                            <a
                              href={github}
                              target="_blank"
                              rel="noopener noreferrer"
                              class="text-sm text-white/80 hover:text-white transition-colors"
                              onclick="(e => { e.stopPropagation(); })(event)"
                            >
                              GitHub →
                            </a>
                          )}
                          {demo && (
                            <a
                              href={demo}
                              target="_blank"
                              rel="noopener noreferrer"
                              class="text-sm text-white/80 hover:text-white transition-colors ml-4"
                              onclick="(e => { e.stopPropagation(); })(event)"
                            >
                              Live Demo →
                            </a>
                          )}
                          {kaggle && (
                            <a
                              href={kaggle}
                              target="_blank"
                              rel="noopener noreferrer"
                              class="text-sm text-white/80 hover:text-white transition-colors ml-4"
                              onclick="(e => { e.stopPropagation(); })(event)"
                            >
                              Kaggle Challenge →
                            </a>
                          )}
                        </div>
                      )}
                    </div>
                  </div>
                  <div class="absolute inset-0 border border-primary/20 rounded-xl transform transition-all duration-300 group-hover:scale-105 group-hover:border-primary/40"></div>
                  <a href={`/project/${project.slug}`} class="absolute inset-0 z-2" aria-hidden="true"></a>
                </div>
              );
            } catch (error) {
              console.error(`Error rendering project:`, error);
              return (
                <div class="bg-red-500/20 p-4 rounded-xl text-white">
                  Error rendering project
                </div>
              );
            }
          })
        ) : (
          <div class="col-span-3 text-center py-8 bg-base-200/30 rounded-xl">
            <p class="text-white/80">No projects found. Check your content collection.</p>
          </div>
        )}
      </div>
    </div>
  </Navbar>
  <Footer />
</Layout>

<!-- Backdrop overlay for blur effect -->
<div id="backdrop-overlay" class="fixed inset-0 bg-black/50 backdrop-blur-md z-5 opacity-0 pointer-events-none transition-opacity duration-300"></div>

<style>
  /* Add Tailwind's line-clamp utility if not available in your Tailwind setup */
  .line-clamp-3 {
    display: -webkit-box;
    -webkit-line-clamp: 3;
    -webkit-box-orient: vertical;
    overflow: hidden;
  }
  
  /* Project card hover animation */
  .project-card {
    transition: transform 0.3s ease-out;
  }
  
  .project-card:hover {
    transform: translateY(-4px);
  }
  
  /* Robot showcase transition effect */
  .robot-showcase {
    transition: all 0.4s ease-out;
  }
  
  /* Robot info card styling */
  .robot-info-card {
    transition: all 0.3s ease-out;
  }
  
  @media (max-width: 767px) {
    .robot-info-card {
      margin-top: 1rem;
    }
  }
  
  /* Bounce animation for the arrow */
  .bounce-arrow {
    animation: bounce 2s infinite;
  }
  
  .bounce-arrow-inline {
    animation: bounce 2s infinite;
    display: inline-block;
  }
  
  @keyframes bounce {
    0%, 20%, 50%, 80%, 100% {
      transform: translateY(0);
    }
    40% {
      transform: translateY(-10px);
    }
    60% {
      transform: translateY(-5px);
    }
  }
  
  /* Backdrop visible class */
  .backdrop-visible {
    opacity: 1 !important;
    pointer-events: auto !important;
  }
  
  /* Expanded robot viewer styling */
  .robot-showcase.expanded {
    position: fixed;
    top: 50%;
    left: 50%;
    transform: translate(-50%, -50%);
    width: 90vw;
    height: 90vw;
    max-width: 800px;
    max-height: 800px;
    z-index: 60;
    border-radius: 12px;
    box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.5);
    border: 2px solid rgba(var(--color-primary, 255, 255, 255), 0.4);
  }
  
  .robot-showcase.expanded .robot-info {
    transform: translateY(0);
    opacity: 1;
  }
</style>

<script>
  document.addEventListener('DOMContentLoaded', () => {
    const robotShowcase = document.querySelector('.robot-showcase');
    const expandButton = document.querySelector('.expand-heavy-robot');
    const backdropOverlay = document.getElementById('backdrop-overlay');
    const bounceArrow = document.querySelector('.bounce-arrow');
    const projectsSection = document.getElementById('projects-section');
    
    // Smooth scroll to projects section when clicking the arrow
    if (bounceArrow && projectsSection) {
      bounceArrow.addEventListener('click', () => {
        projectsSection.scrollIntoView({ behavior: 'smooth' });
      });
    }
    
    if (robotShowcase && expandButton && backdropOverlay) {
      // Toggle expanded view
      expandButton.addEventListener('click', (e) => {
        e.stopPropagation(); // Prevent event from bubbling
        e.preventDefault(); // Prevent navigation
        toggleExpandedView();
      });
      
      // Allow clicking on backdrop to close expanded view
      backdropOverlay.addEventListener('click', () => {
        if (robotShowcase.classList.contains('expanded')) {
          toggleExpandedView(false);
        }
      });
      
      // Close on escape key
      document.addEventListener('keydown', (e) => {
        if (e.key === 'Escape' && robotShowcase.classList.contains('expanded')) {
          toggleExpandedView(false);
        }
      });

      // Function to toggle the expanded view state
      function toggleExpandedView(expand: boolean | null = null) {
        const shouldExpand = expand !== null ? expand : (robotShowcase && !robotShowcase.classList.contains('expanded'));
        
        if (shouldExpand) {
          // Expand the view
          if (robotShowcase) {
            robotShowcase.classList.add('expanded');
          }
          if (backdropOverlay) {
            backdropOverlay.classList.add('backdrop-visible');
          }
          document.body.style.overflow = 'hidden'; // Prevent scrolling
          if (expandButton) {
            expandButton.setAttribute('aria-label', 'Collapse robot view');
          }
          
          // Update SVG in button
          const svg = expandButton ? expandButton.querySelector('svg') : null;
          if (svg) {
            svg.style.transform = 'rotate(180deg)';
          }
          
          // Dispatch custom event for the robot viewer to adjust its controls
          document.dispatchEvent(new CustomEvent('heavyRobotViewerStateChange', {
            detail: { expanded: true }
          }));
        } else {
          // Collapse the view
          if (robotShowcase) {
            robotShowcase.classList.remove('expanded');
          }
          if (backdropOverlay) {
            backdropOverlay.classList.remove('backdrop-visible');
          }
          document.body.style.overflow = ''; // Restore scrolling
          if (expandButton) {
            expandButton.setAttribute('aria-label', 'Expand robot view');
          }
          
          // Reset SVG in button
          const svg = expandButton ? expandButton.querySelector('svg') : null;
          if (svg) {
            svg.style.transform = '';
          }
          
          // Dispatch custom event for the robot viewer to adjust its controls
          document.dispatchEvent(new CustomEvent('heavyRobotViewerStateChange', {
            detail: { expanded: false }
          }));
        }
      }
    }
  });
</script>